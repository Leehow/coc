<div class="tab-pane fade h-100 show active" id="tab-content-control-chat" role="tabpanel">
                        <div class="d-flex flex-column h-100">

                            <div class="hide-scrollbar">
                                <div class="container-fluid py-6">

                                    <!-- Title -->
                                    <h2 class="font-bold mb-6">守密人工具台</h2>
                                    <!-- Title -->

                                    <!-- Tabs -->
                                    <ul class="nav nav-tabs nav-justified mb-6" role="tablist">
                                        <li class="nav-item">
                                            <a href="#book-deteils" class="nav-link active" data-toggle="tab" role="tab" aria-selected="true">剧本</a>
                                        </li>

                                        <li class="nav-item">
                                            <a href="#monster-list" class="nav-link" data-toggle="tab" role="tab" aria-selected="false">怪物</a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="#tou-list" class="nav-link" data-toggle="tab" role="tab" aria-selected="false">骰子</a>
                                        </li>
                                        <li class="nav-item">
                                            <a href="#show_themap" class="nav-link" data-toggle="tab" role="tab" aria-selected="false">图片</a>
                                        </li>
                                    </ul>
                                    <!-- Tabs -->

                                    <!-- Search -->
                                    <form class="mb-6">
                                        <div class="input-group">
                                            <input type="text" class="form-control form-control-lg" placeholder="搜索" aria-label="搜索">
                                            <div class="input-group-append">
                                                <button class="btn btn-lg btn-ico btn-secondary btn-minimal" type="submit">
                                                    <i class="fe-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                    <!-- Search -->


                                    <!-- 游戏详细内容 -->
                                    <div class="tab-content" role="tablist">

                                        <!-- 剧本工具 -->
                                        <div id="book-deteils" class="tab-pane fade show active" role="tabpanel">

                                            <div id="show_jb_list" class="accordion">
                                                <h3>剧本</h3>

                                            </div>

                                            <div style="display: none">
                                                <div id="temp_jb_s" class="card">
                                                <div class="card-header" id="headingOne">
                                                    <div class="input-group">
                                                    <input type="text" class="form-control jb_c_textt" placeholder="剧本名称">
                                                     <div class="input-group-append">
                                                         <button onclick="sent_jbcj()" type="button" class="btn btn-secondary jb_cj_sent" title="发出">
                                                                    <i class="fe-corner-down-right"></i>
                                                                </button>
                                                         <button onclick="del_jbcj()" type="button" class="btn btn-secondary jb_cj_del" title="删除场景">
                                                                    <i class="fe-x"></i>
                                                                </button>
                                                         <button type="button" onclick="" class="btn btn-secondary jb_c_text" title="展开" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                                <i class="fe-chevron-down"></i>
                                                            </button>
                                                    </div>
                                                </div>
                                                </div>

                                                <div id="collapseOne" class="collapse jb_c_deteil" aria-labelledby="headingOne" data-parent="#accordionExample">
                                                  <div class="card-body">
                                                      <textarea class="form-control form-control-lg jb_c_deteil_text" name="new-chat-description" rows="3" data-autosize="true" placeholder="文字">

                                                      </textarea>

                                                      <div class="pluss"></div>

                                                      <p> </p>
                                                      <a class="text-muted jb_xs_pp" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false">
                                                            添加线索/次级场景
                                                        </a>
                                                      <div class="collapse jb_xs_ppin" id="collapseExample">
                                                      <div class="card card-body">
                                                            <div class="input-group">
                                                                <input type="text" class="form-control jb_xs_name" placeholder="线索/次级场景">
                                                                 <div class="input-group-append">
                                                                     <button onclick="send_jbcj()" type="button" class="btn btn-primary jb_xs_sub" title="确认添加">
                                                                            <i class="fe-plus"></i>
                                                                        </button>
                                                                </div>
                                                            </div>
                                                      </div>
                                                      </div>

                                                  </div>
                                                </div>
                                              </div>

                                                <div class="accordion" id="accordionExample1">
                                                          <div class="card">
                                                            <div class="card-header" id="headingOne1">
                                                              <h2 class="mb-0">
                                                                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOne1" aria-expanded="true" aria-controls="collapseOne1">
                                                                  Collapsible Group Item #1
                                                                </button>
                                                              </h2>
                                                            </div>

                                                            <div id="collapseOne1" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample1">
                                                              <div class="card-body">
                                                                Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth nesciunt you probably haven't heard of them accusamus labore sustainable VHS.
                                                              </div>
                                                            </div>
                                                          </div>
                                                        </div>

                                                <div id="temp_jbcj" class="card">
                                                    <div class="card-body">
                                                    <div class="input-group">

                                                         <div class="input-group-prepend">
                                                            <label class="input-group-text">
                                                                <span class="jb_cji_label">添加场景</span>:&nbsp;&nbsp;
                                                            </label>
                                                        </div>
                                                        <input type="text" class="form-control jb_cji_name" placeholder="场景名称">
                                                         <div class="input-group-append">
                                                             <button onclick="send_jbcj()" type="button" class="btn btn-primary jb_cj_sub" title="确认添加">
                                                                    <i class="fe-plus"></i>
                                                                </button>
                                                        </div>
                                                    </div>
                                                    </div>
                                                </div>

                                            </div>
<!-- ---------------------------------------------------------------------------前面是框内的内容 -------------------------------- -->
                                            <p> </p>
                                            <form action="#">
                                                <div class="input-group">
                                                     <div class="input-group-prepend">
                                                        <label class="input-group-text">
                                                            <span class="jb_n_label">添加剧本</span>:&nbsp;&nbsp;
                                                        </label>
                                                    </div>
                                                    <input id="jb_name_input" type="text" class="form-control jb_name" placeholder="剧本名称">
                                                     <div class="input-group-append">
                                                         <button onclick="send_jbname()" type="button" class="btn btn-info" title="确认添加">
                                                                <i class="fe-plus"></i>
                                                            </button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <!-- 剧本工具 -->

                                        <!-- 怪物管理 -->
                                        <div id="monster-list" class="tab-pane fade" role="tabpanel">
                                            <nav class="list-group list-group-flush mb-n6">
                                                建设当中...
                                            </nav>
                                        </div>
                                        <!-- 怪物管理 -->

                                        <!-- 骰子提示管理 -->
                                        <div id="tou-list" class="tab-pane fade" role="tabpanel">
                                            <h5>难度</h5>
                                            <select id="toul_dif" onchange="send_tdi()" class="form-control custom-select">
                                              <option value="0">几乎必中 (npc必然大失败)</option>
                                              <option value="10">非常简单 (难度值10)</option>
                                              <option value="25">简单 (难度值25)</option>
                                              <option value="50" selected="selected">普通 (难度值50)</option>
                                              <option value="75">困难 (难度值75)</option>
                                              <option value="100">超难 (npc必然大成功)</option>
                                            </select>
                                            <input id="toul_diffi" type="hidden" value="50" />
                                            <p> </p>
                                            <nav id="list_toulist" class="list-group list-group-flush mb-n6">

                                            </nav>
                                        </div>
<!--                                        骰子组合的模板-->
                                            <div class="d-none">
                                                <a id="temp_toulist" class="text-reset nav-link p-0 mb-6" href="#">
                                                    <div class="card card-active-listener">
                                                        <div class="card-body">
                                                            <div class="media">
                                                                <div class="media-body overflow-hidden">
                                                                    <div class="d-flex align-items-center mb-1">
                                                                        <h6 class="text-truncate mb-0 mr-auto ttext">撞击：<small>(力量+运动)</small></h6>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>
                                                    <div id="temp_toulist2">
                                                        <h6><a class="text-dark tile" data-toggle="collapse" href="#" role="button" aria-expanded="true" aria-controls="">
                                                        点击查看房间简介</a></h6>
                                                        <div class="collapse detl" style="">
                                                        <p>好房间</p>
                                                        </div>
                                                    </div>
                                            </div>

                                        <!-- 骰子提示管理 -->

                                        <!-- 图片上传 -->
                                        <div id="show_themap" class="tab-pane fade" role="tabpanel">
                                            <div class="hide-scrollbar flex-fill">

                                                <div class="border-bottom text-center py-9 px-10">
                                                    <!-- map的 dropzone上传  -->
                                                    <div id="dropzone-map-1" class="dropzone-map-js" data-dz-url="{{ url_for('upload_map') }}">

                                                        <button id="map-upload-btn-1" class="btn btn-primary btn-lg dropzone-button-js" type="button">上传图片</button>

                                                        <div class="container-xxl">
                                                            <div class="dropzone-previews-js form-row py-4"></div>
                                                        </div>
                                                    </div>

                                                </div>

                                                <!-- Navs -->
                                                <ul class="nav nav-tabs nav-justified bg-light rounded-0" role="tablist">
                                                    <!-- <li class="nav-item">
                                                        <a href="#chat-id-1-members" class="nav-link active" data-toggle="tab" role="tab" aria-selected="true">Members</a>
                                                    </li> -->
                                                    <li class="nav-item">
                                                        <a>已上传文件</a>
                                                    </li>
                                                </ul>
                                                <!-- Navs -->

                                                <div class="tab-content">
                                                    <!-- Members -->
                <!--                                    <div id="chat-id-1-members" class="tab-pane fade show active">-->

                <!--                                    </div>-->
                                                    <!-- Members -->

                                                    <!-- Files -->
                                                    <div id="chat-id-2-files" class="tab-pane fade show active">
                                                        <ul class="list-group list-group-flush list-group-no-border-first map_list">

                                                        </ul>
                                                    </div>
                                                    <!-- Files -->
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 图片上传 -->

                                    </div>
                                    <!-- 游戏详细内容 -->

                                </div>
                            </div>

                            <!-- Button -->
<!--                            <div class="pb-6">-->
<!--                                <div class="container-fluid">-->
<!--                                    <button class="btn btn-lg btn-primary btn-block" type="submit">Create group</button>-->
<!--                                </div>-->
<!--                            </div>-->

                        </div>
                    </div>













<!-- -----------------------------------------------------------------------------------------------------------------------模板-->




        <!-- DropzoneJS: Template -->
        <div id="dropzone-template-js">
            <div class="col-lg-4 my-3">
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <div class="media align-items-center">

                            <div class="dropzone-file-preview">
                                <div class="avatar avatar rounded bg-secondary text-basic-inverse d-block mr-5">
                                    <i class="fe-paperclip"></i>
                                </div>
                            </div>

                            <div class="dropzone-image-preview">
                                <div class="avatar avatar mr-5">
                                    <img src="#" class="avatar-img rounded" data-dz-thumbnail="" alt="">
                                </div>
                            </div>

                            <div class="media-body overflow-hidden">
                                <h6 class="text-truncate small mb-0" data-dz-name></h6>
                                <p class="extra-small" data-dz-size></p>
                            </div>

                            <div class="ml-5">
                                <a href="#" class="btn btn-sm btn-link text-decoration-none text-muted" data-dz-remove>
                                    <i class="fe-x"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- DropzoneJS: Template -->




<!-- 文件显示列表：Template -->
        <div id="file-list-template" class="d-none">
            <li id="file-list-template-0" class="list-group-item py-6">
                <div class="media">

                    <div class="avatar avatar-sm mr-5">
                                        <img class="avatar-img map_smallpic" src="" alt="">
                                    </div>

<!--                    <div class="icon-shape bg-primary text-white mr-5">-->
<!--                        <i class="fe-paperclip"></i>-->
<!--                    </div>-->

                    <div class="media-body align-self-center overflow-hidden">
                        <h6 class="text-truncate mb-0">
                            <a href="#" class="text-reset map_name" title="file-list-template-filename">file-list-template-filename</a>
                        </h6>
                    </div>

                    <div class="align-self-center ml-5">
                        <div class="dropdown">
                            <a href="#" class="btn btn-sm btn-ico btn-link text-muted w-auto" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fe-more-vertical"></i>
                            </a>
                            <div imgurl="file-list-template-imgurl" class="dropdown-menu map_showu">
                                <div class="file-list-template-display">
                                     <a class="dropdown-item d-flex align-items-center map_send" onclick="" href="#">
                                     图片发送 <span class="ml-auto fe-map"></span>
                                     </a>
                                 </div>
                                <div class="file-list-template-display">
                                     <a class="dropdown-item d-flex align-items-center map_showh" onclick="" href="#" data-toggle="modal" data-target="#dshowimg">
                                     图片显示 <span class="ml-auto fe-map"></span>
                                     </a>
                                 </div>
                                 <div class="file-list-template-delete">
                                     <a class="dropdown-item d-flex align-items-center"  href="#">
                                     删除 <span class="ml-auto fe-trash-2"></span>
                                     </a>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </li>

        </div>


<script>
    var tou_list_cl=0;
    var tou_list_li=0;
    $(document).ready(function() {
        get_kprom();
        // 获取剧本相关信息
        get_jbinfo();
    });
    //取出所有初始数据
    function get_kprom() {
        // 0:name| 1:atrr| 2:infoe|
        $.post("/getkprom", {
                token:"{{token}}",
                gid:"{{group_id}}"
              },
                function(myData , status){
                    // console.log(myData);
                    var names = myData[0];
                    var attr  = myData[1];
                    var infoe = myData[2];
                    for(ii in names){
                        nam = names[ii];
                        if(nam[1]==10){
                            var nid = nam[0];
                            var nn = nam[2];
                            var des=n_infoe(infoe,nid);
                            for(iii in des){
                                if(des[iii][2]==91){
                                    var shuxing = des[iii];
                                }
                                else if(des[iii][2]==92){
                                    var jineng  = des[iii];
                                }
                            }
                            var shuxing_aid =shuxing[4];
                            var jineng_nid  =jineng[4];
                            var shuxing_n = n_na(attr,shuxing_aid);
                            var jineng_n = n_na(names,jineng_nid);
                            set_kptoulist("list_toulist","temp_toulist2","tl2_"+jineng_n[0],"temp_toulist","tl_"+nid,nid,nn,shuxing_n,jineng_n);
                        }
                    }
                    tou_list_cl=0;
                },"json");
    }

    //------------------------------------------------------------------骰子相关
    //列表
    function set_kptoulist(list,temp2,chid2,temp,chid,nid,name,vv1,vv2) {
        var v1 = vv1[2];
        var v2 = vv2[2];
        var v1id = vv1[0];
        var v2id = vv2[0];
        if(tou_list_cl!=v2){
            var template2 = $("#"+temp2).clone(true);
            template2.attr('id',chid2);
            var chid3 = chid2+"p";
            $("#"+list).append(template2);
            $("#"+chid2+" .tile").html(v2);
            $("#"+chid2+" .tile").attr("href","#"+chid3);
            $("#"+chid2+" .tile").attr("aria-controls",chid3);
            $("#"+chid2+" .detl").html("");
            $("#"+chid2+" .detl").attr("id",chid3);
            tou_list_cl=v2;
        }

        var template = $("#"+temp).clone(true);
        template.attr('id',chid);

        // $("#"+list).append(template);
        $("#"+chid2+" .detl").append(template);

        var ht = name+" = <small>"+v1+"+"+v2+"</small>";
        $("#"+chid).attr("onclick","send_mst('"+name+"',"+nid+","+v1id+",'"+v1+"',"+v2id+",'"+v2+"')");
        $("#"+chid+" .ttext").html(ht);
    }

    function send_mst(name, nid, v1id, v1, v2id, v2) {
        var ht = name+" = <small>"+v1+"+"+v2+"</small>";
        var diffi = $("#toul_diffi").val();
        var mg = ht+" <a href=\"#\" onclick=\"toul("+nid+","+v1id+","+v2id+","+diffi+")\" class=\"btn btn-info btn-sm\">投骰子</a>";
        send_msg(mg);
    }

    //infoe中取出参数
    function n_infoe(infoe, nid, aid = 0){
        var out = new Array();
        for(ii in infoe){
            var nnid = infoe[ii][1];
            var aaid = infoe[ii][2];
            if(aid==0){
                if(nid==nnid){
                    out.push(infoe[ii]);
                }
            }
            else{
                if(nid==nnid && aid==aaid){
                    out.push(infoe[ii]);
                }
            }
        }
        return out;
    }

    //names中取出参数
    function n_na(na, nid){
        for(ii in na){
            var nnid = na[ii][0];
            if(nid==nnid){
                return na[ii];
            }
        }
    }

    //骰子难度
    function send_tdi(){
        var td = $("#toul_dif").val();
        $("#toul_diffi").val(td);
    }

    //-------------------------------------------------------------------剧本相关
    // 插入剧本名称
    function send_jbname() {
        var jb_name = $("#jb_name_input").val();
        var method = "jb_name";
        $.post("/add_jb", {
            method:method,
            value:jb_name,
            token: "{{token}}",
            gid:"{{group_id}}"
            },
            function(myData , status){
                $("#jb_name_input").val("");
                get_jbinfo();
                // alert("成功加入剧本");
                // console.log(myData);
            });
    }

    //获取剧本信息
    function get_jbinfo() {
        $.get("/get_jb", {
            gid:"{{group_id}}"
            },
            function(myData , status){
                $("#show_jb_list").html("");
                for(ii in myData){
                    var data = myData[ii];
                    var id = data[0];
                    var name = data[1];
                    var list_v =data[2];
                    $("#show_jb_list").append("<div id='jb_list_"+id+"'></div><p> </p>");
                    $("#jb_list_"+id).append("<h3>"+name+"</h3>");
                    $("#jb_list_"+id).append("<p align='right'><a class='text-muted' href='#' onclick='del_jb(\""+id+"\",\"juben\")'><small>删除剧本</small></a></p>");
                    for(iii in list_v){
                        var iid = list_v[iii][0];
                        var title =list_v[iii][4];
                        var detei =list_v[iii][5];
                        set_cjxs("changjing", "jb_list_", "jb_s_", id,iid,title,detei);
                    }

                    var temp_cj = $("#temp_jbcj").clone(true);
                    temp_cj.attr("id","temp_jbcj_"+id);
                    $("#jb_list_"+id).append(temp_cj);

                    $("#temp_jbcj_"+id+" .jb_cji_name").attr("id","jb_cji_name_"+id);
                    $("#temp_jbcj_"+id+" .jb_cj_sub").attr("onclick","send_jbcj("+id+",'changjing','jb_cji_name_"+id+"')");

                    autosize($('textarea'));
                }
                // console.log(myData);
            });
    }
    
    //获取一个场景下的线索
    function get_xs(id, list_xs, method,idd=0) {
        $.get("/get_xs", {
            id:id
            },
            function(myData , status){
                if(!myData){
                    return;
                }
                $("#"+list_xs+idd).html("");
                for(ii in myData){
                    var data = myData[ii];
                    var iid = data[0];
                    var title = data[4];
                    var detei = data[5];
                    var upid  = data[6];
                    var upid2 = data[7];
                    set_cjxs(method, list_xs, "jb_xs_", id, iid, title, detei, upid, idd);
                    autosize($('textarea'));
                }
            });

    }


    //给场景和线索设定模板 set_cjxs(method, jb_list_, jb_s_, id,iid,title,detei)
    function set_cjxs(method, list_id, set_id, id,iid,title,detei, upid=0 ,idd=0) {
        if(method=="changjing"){
            var xid = iid
            var method2= "xiansuo";
            idd = id
        }
        else if(method=="xiansuo"){
            var xid = upid
            var method2= "xiansuo";

        }
        var temp = $("#temp_jb_s").clone(true);
        temp.attr("id",set_id+iid);
        $("#"+list_id+idd).append(temp);
        $("#"+set_id+iid+" .jb_c_deteil").attr("data-parent","#"+list_id+idd);
        $("#"+set_id+iid+" .jb_c_deteil").attr("id","collapse_"+iid);

        //场景1
        $("#"+set_id+iid+" .jb_c_textt").val(title);
        $("#"+set_id+iid+" .jb_c_textt").attr("id","jb_c_textt_"+iid);
        $("#"+set_id+iid+" .jb_c_textt").attr("onblur","update_jb("+iid+",1, 'jb_c_textt_"+iid+"')");
        //展开按钮
        $("#"+set_id+iid+" .jb_c_text").attr("data-target","#collapse_"+iid);
        $("#"+set_id+iid+" .jb_c_text").attr("aria-controls","#collapse_"+iid);
        //展开后显示列表
        $("#"+set_id+iid+" .pluss").attr("id","list_xs_"+iid); //列表赋一个id
        $("#"+set_id+iid+" .jb_c_text").attr("onclick","get_xs("+iid+",'list_xs_','"+method2+"',"+iid+")");


        $("#"+set_id+iid+" .jb_c_deteil_text").val(detei);
        $("#"+set_id+iid+" .jb_c_deteil_text").attr("id","jb_c_deteil_text_"+iid);
        $("#"+set_id+iid+" .jb_c_deteil_text").attr("onblur","update_jb("+iid+",2, 'jb_c_deteil_text_"+iid+"')");

        //将场景/线索发送至公屏
        $("#"+set_id+iid+" .jb_cj_sent").attr("onclick","sent_jb("+iid+")");

        //删除按钮
        $("#"+set_id+iid+" .jb_cj_del").attr("onclick","del_jb("+iid+",'"+method+"',"+xid+","+idd+")");

        //显示隐藏添加按钮
        $("#"+set_id+iid+" .jb_xs_pp").attr("href","#xs_pluk_"+iid);
        $("#"+set_id+iid+" .jb_xs_ppin").attr("id","xs_pluk_"+iid);

        //添加线索/次级场景
        $("#xs_pluk_"+iid+" .jb_xs_name").attr("id","xs_name_"+iid);
        $("#xs_pluk_"+iid+" .jb_xs_sub").attr("onclick","send_jbcj("+xid+",'"+method2+"','xs_name_"+iid+"',"+iid+")");
    }

    function update_jb(id,num,valid) {
        var value = $("#"+valid).val();
        $.post("/update_jb", {
            id:id,
            method:num,
            value:value,
            token: "{{token}}"
            },
            function(myData , status){
            });
    }

    //将场景/信息发送出来
    function sent_jb(id) {
        var title = $("#jb_c_textt_"+id).val();
        var detei = $("#jb_c_deteil_text_"+id).val();
        var ht = "<h5>"+title+"</h5>"+detei;
        send_msg(ht);
    }
    //加入场景/线索
    function send_jbcj(id, method=0, valueid=0, upid2=0) {
        var value = $("#"+valueid).val();
        $.post("/add_jb", {
            method:method,
            value:value,
            upid:id,
            upid2:upid2,
            token: "{{token}}",
            gid:"{{group_id}}"
            },
            function(myData , status){
                $("#"+valueid).val("");
                if(method=="changjing"){
                    $("#jb_name_input").val("");
                    get_jbinfo();
                }
                else{
                    get_xs(upid2,'list_xs_',method,upid2)
                }

            });
    }

    function del_jb(id, method, upid=0, iid=0){
        var r = confirm("确定删除这个场景吗？");
        if (r == false) {
            return
        }
        $.post("/delet_jb", {
            method:method,
            id:id,
            token: "{{token}}",
            gid:"{{group_id}}"
            },
            function(myData , status){
                if(method=="changjing"){
                    $("#jb_name_input").val("");
                    get_jbinfo();
                }
                else{
                    get_xs(iid,'list_xs_',method,iid)
                }
            });
    }


</script>